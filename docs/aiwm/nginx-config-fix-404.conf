# ============================================
# Fix for 404 Not Found on /socket.io/
# ============================================

# Add this to /etc/nginx/sites-available/api.x-or.cloud

server {
    listen 443 ssl http2;
    server_name api.x-or.cloud;

    # ... existing SSL config ...

    # ========================================
    # Option 1: Redirect /socket.io/ to /dev/aiwm/chat
    # ========================================
    location /socket.io/ {
        # Rewrite to correct path
        rewrite ^/socket.io/(.*)$ /dev/aiwm/chat/socket.io/$1 break;

        proxy_pass http://api-aiwm-ws;

        # WebSocket headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeouts
        proxy_connect_timeout 604800s;
        proxy_send_timeout 604800s;
        proxy_read_timeout 604800s;

        proxy_buffering off;
        proxy_cache off;
    }

    # ========================================
    # WebSocket endpoint (existing config)
    # ========================================
    location /dev/aiwm/chat {
        access_log /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.access.log;
        error_log  /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.error.log;

        proxy_pass http://api-aiwm-ws;

        # WebSocket headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeouts (7 days)
        proxy_connect_timeout 604800s;
        proxy_send_timeout 604800s;
        proxy_read_timeout 604800s;

        proxy_buffering off;
        proxy_cache off;
    }

    # Regular API endpoints (existing)
    location /dev/aiwm/ {
        access_log /var/log/nginx/api.x-or.cloud/path-dev-aiwm-v2.access.log;
        error_log  /var/log/nginx/api.x-or.cloud/path-dev-aiwm-v2.error.log;
        include /etc/nginx/cors-01.conf;
        proxy_pass http://api-aiwm/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}


# ============================================
# Recommended: Update Client Code Instead
# ============================================

# Client should connect to the correct path:

# JavaScript/Node.js
const io = require('socket.io-client');
const socket = io('https://api.x-or.cloud/dev/aiwm/chat', {
  auth: {
    token: 'YOUR_JWT_TOKEN'
  },
  transports: ['websocket']
});

# Python
import socketio
sio = socketio.Client()
sio.connect('https://api.x-or.cloud/dev/aiwm/chat',
  auth={'token': 'YOUR_JWT_TOKEN'},
  transports=['websocket']
)


# ============================================
# Why Client is Wrong
# ============================================

# Socket.IO client is trying to connect to:
# https://api.x-or.cloud/socket.io/?token=...&EIO=4&transport=websocket

# But server is configured at:
# https://api.x-or.cloud/dev/aiwm/chat

# Socket.IO internally appends /socket.io/ to the base URL
# So if base URL is "https://api.x-or.cloud", it tries "https://api.x-or.cloud/socket.io/"
# If base URL is "https://api.x-or.cloud/dev/aiwm/chat", it tries "https://api.x-or.cloud/dev/aiwm/chat/socket.io/"


# ============================================
# Testing
# ============================================

# Test with correct URL:
wscat -c "wss://api.x-or.cloud/dev/aiwm/chat/socket.io/?EIO=4&transport=websocket" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Should return:
# 0{"sid":"...","upgrades":[],"pingInterval":25000,"pingTimeout":20000}
