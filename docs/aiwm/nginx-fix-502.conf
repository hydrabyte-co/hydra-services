# ============================================
# Fix 502 Bad Gateway - Correct proxy_pass
# ============================================

# File: /etc/nginx/sites-available/api.x-or.cloud

server {
    listen 443 ssl http2;
    server_name api.x-or.cloud;

    # ... existing SSL config ...

    # ========================================
    # CORRECT: WebSocket with path rewrite
    # ========================================
    location /dev/aiwm/chat/ {
        access_log /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.access.log;
        error_log  /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.error.log;

        # CRITICAL: Trailing slash in proxy_pass removes /dev/aiwm prefix
        proxy_pass http://api-aiwm-ws/chat/;
        #                                 ^^^^^^^ This rewrites path

        # WebSocket headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Preserve client info
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeouts (7 days)
        proxy_connect_timeout 604800s;
        proxy_send_timeout 604800s;
        proxy_read_timeout 604800s;

        # Disable buffering
        proxy_buffering off;
        proxy_cache off;
    }

    # Regular API endpoints (existing)
    location /dev/aiwm/ {
        access_log /var/log/nginx/api.x-or.cloud/path-dev-aiwm-v2.access.log;
        error_log  /var/log/nginx/api.x-or.cloud/path-dev-aiwm-v2.error.log;
        include /etc/nginx/cors-01.conf;
        proxy_pass http://api-aiwm/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}


# ============================================
# Explanation: How proxy_pass path rewriting works
# ============================================

# Client request: https://api.x-or.cloud/dev/aiwm/chat/socket.io/?EIO=4&transport=websocket

# WRONG (what you have now):
location /dev/aiwm/chat {
    proxy_pass http://backend;
}
# Backend receives: http://backend/dev/aiwm/chat/socket.io/
# But backend only listens at: /chat/socket.io/
# Result: 502 Bad Gateway

# CORRECT (with trailing slash):
location /dev/aiwm/chat/ {
    proxy_pass http://backend/chat/;
    #                         ^^^^^^ Replaces /dev/aiwm/chat/ with /chat/
}
# Backend receives: http://backend/chat/socket.io/
# Backend listens at: /chat/socket.io/
# Result: SUCCESS!


# ============================================
# Path Rewriting Rules
# ============================================

# Rule 1: proxy_pass WITHOUT trailing slash = preserve full path
location /dev/aiwm/chat {
    proxy_pass http://backend;
}
# Request: /dev/aiwm/chat/socket.io/
# Proxied: http://backend/dev/aiwm/chat/socket.io/

# Rule 2: proxy_pass WITH trailing slash = replace matched prefix
location /dev/aiwm/chat/ {
    proxy_pass http://backend/chat/;
}
# Request: /dev/aiwm/chat/socket.io/
# Proxied: http://backend/chat/socket.io/

# Rule 3: If location has trailing slash, proxy_pass MUST also have it
location /dev/aiwm/chat/ {
    proxy_pass http://backend/chat/;  # CORRECT
}

location /dev/aiwm/chat/ {
    proxy_pass http://backend/chat;   # WRONG - will cause issues
}


# ============================================
# Testing Commands
# ============================================

# 1. Update nginx config
sudo nano /etc/nginx/sites-available/api.x-or.cloud

# 2. Test syntax
sudo nginx -t

# 3. Reload
sudo nginx -s reload

# 4. Check backend is running
curl http://localhost:3350/chat/socket.io/?EIO=4&transport=polling

# Expected response:
# 0{"sid":"xxx","upgrades":["websocket"],"pingInterval":25000,"pingTimeout":20000}

# 5. Test through Nginx
wscat -c "wss://api.x-or.cloud/dev/aiwm/chat/socket.io/?EIO=4&transport=websocket&token=YOUR_TOKEN"

# Expected: Connection established


# ============================================
# If still getting 502, check:
# ============================================

# 1. Backend processes running
pm2 list
# or
ps aux | grep node

# 2. Backend listening on correct port
netstat -tlnp | grep 3350
netstat -tlnp | grep 3351
netstat -tlnp | grep 3352

# 3. Backend logs
pm2 logs aiwm
# or
tail -f /path/to/aiwm.log

# 4. Nginx error logs
sudo tail -f /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.error.log

# 5. Test direct connection to backend (bypass Nginx)
curl http://localhost:3350/chat/socket.io/?EIO=4&transport=polling

# 6. Check firewall
sudo iptables -L -n | grep 3350
