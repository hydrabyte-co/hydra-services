# ============================================
# AIWM Nginx Configuration for Production
# ============================================
# File: /etc/nginx/upstream.d/aiwm.conf
# ============================================

# Upstream for regular HTTP/REST API endpoints
# Round-robin load balancing (no sticky needed)
upstream api-aiwm {
    server 172.16.2.100:3350 max_fails=3 fail_timeout=30s;
    server 172.16.2.100:3351 max_fails=3 fail_timeout=30s;
    server 172.16.2.100:3352 max_fails=3 fail_timeout=30s;
    keepalive 64;
}

# Upstream for WebSocket connections
# MUST use ip_hash for sticky sessions
upstream api-aiwm-ws {
    ip_hash;  # CRITICAL: Sticky sessions for WebSocket
    server 172.16.2.100:3350 max_fails=3 fail_timeout=30s;
    server 172.16.2.100:3351 max_fails=3 fail_timeout=30s;
    server 172.16.2.100:3352 max_fails=3 fail_timeout=30s;
    keepalive 64;
}


# ============================================
# File: /etc/nginx/sites-available/api.x-or.cloud
# ============================================

server {
    listen 443 ssl http2;
    server_name api.x-or.cloud;

    # SSL configuration (existing)
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # ========================================
    # WebSocket endpoint - MUST come BEFORE regular API
    # ========================================
    location /dev/aiwm/chat {
        access_log /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.access.log;
        error_log  /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.error.log;

        # Use WebSocket upstream with sticky sessions
        proxy_pass http://api-aiwm-ws;

        # WebSocket upgrade headers (CRITICAL)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Preserve client information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeouts for WebSocket (7 days)
        proxy_connect_timeout 604800s;
        proxy_send_timeout 604800s;
        proxy_read_timeout 604800s;

        # Disable buffering for real-time communication
        proxy_buffering off;
        proxy_cache off;

        # CORS not needed for WebSocket (handled by Socket.IO)
        # Do NOT include cors-01.conf here
    }

    # ========================================
    # Regular HTTP/REST API endpoints
    # ========================================
    location /dev/aiwm/ {
        access_log /var/log/nginx/api.x-or.cloud/path-dev-aiwm-v2.access.log;
        error_log  /var/log/nginx/api.x-or.cloud/path-dev-aiwm-v2.error.log;

        # CORS for REST API
        include /etc/nginx/cors-01.conf;

        # Use regular upstream (round-robin)
        proxy_pass http://api-aiwm/;

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Standard timeouts for HTTP (60s)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}


# ============================================
# Testing Commands
# ============================================

# 1. Test configuration syntax
# sudo nginx -t

# 2. Reload Nginx
# sudo nginx -s reload

# 3. Test WebSocket connection
# npm install -g wscat
# wscat -c "wss://api.x-or.cloud/dev/aiwm/chat" -H "Authorization: Bearer YOUR_TOKEN"

# 4. Monitor logs
# sudo tail -f /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.access.log
# sudo tail -f /var/log/nginx/api.x-or.cloud/path-dev-aiwm-ws.error.log

# 5. Check which backend instance is used (sticky session test)
# - Connect multiple times from same IP
# - All connections should go to same backend instance
# - Check logs to verify


# ============================================
# Important Notes
# ============================================

# 1. Port 3350 appears twice in original config - fixed to use 3350, 3351, 3352
# 2. WebSocket location MUST come before /dev/aiwm/ (more specific first)
# 3. ip_hash ensures same client IP always connects to same backend
# 4. Long timeouts (7 days) prevent WebSocket disconnections
# 5. Separate upstreams allow different load balancing strategies
# 6. Do NOT include CORS config for WebSocket endpoint
